<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ® | ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #e67e22;
            --success: #27ae60;
            --danger: #c0392b;
            --bundle: #8e44ad;
            --bg: #f4f7f6;
            --white: #ffffff;
        }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        header { background-color: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .logo h1 { margin: 0; font-size: 1.5rem; }
        .cart-icon { position: relative; cursor: pointer; font-size: 1.5rem; }
        .badge-count { position: absolute; top: -8px; right: -10px; background: var(--secondary); color: white; border-radius: 50%; padding: 4px 8px; font-size: 0.8rem; font-weight: bold; }
        .nav-scroll { background: var(--white); padding: 10px; overflow-x: auto; white-space: nowrap; position: sticky; top: 65px; z-index: 90; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cat-pill { display: inline-block; background: #eee; padding: 8px 16px; border-radius: 20px; margin-left: 10px; cursor: pointer; transition: 0.3s; }
        .cat-pill.active { background: var(--primary); color: white; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; position: relative; }
        .tag { position: absolute; top: 10px; right: 10px; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color: white; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tag-red { background: var(--danger); }
        .tag-purple { background: var(--bundle); }
        .img-wrap { width: 100%; height: 160px; background: #eee; }
        .img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .info { padding: 12px; display: flex; flex-direction: column; flex: 1; }
        .title { font-size: 1rem; font-weight: bold; margin-bottom: 5px; }
        .desc { font-size: 0.8rem; color: #777; margin-bottom: 8px; flex: 1; }
        .pricing { margin: 10px 0; min-height: 45px; display: flex; flex-direction: column; justify-content: center; }
        .price-cross { text-decoration: line-through; color: #999; font-size: 0.9rem; }
        .price-final { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .price-final.red { color: var(--danger); }
        .price-final.purple { color: var(--bundle); }
        .bundle-note { font-size: 0.75rem; background: #f3e5f5; color: var(--bundle); padding: 3px 6px; border-radius: 4px; display: inline-block; width: fit-content; margin-top: 3px; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; font-family: inherit; margin-top: auto; }
        .btn-add:active { transform: scale(0.98); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: flex-end; }
        @media(min-width: 768px) { .modal-overlay { align-items: center; } .modal-body { max-height: 85vh; border-radius: 15px; } }
        .modal-body { background: white; width: 100%; max-width: 500px; height: 90vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; padding: 20px; animation: slideUp 0.3s forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cart-list { flex: 1; overflow-y: auto; margin: 15px 0; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .checkout-box { background: #f9f9f9; padding: 15px; border-radius: 10px; }
        .inp { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-wa { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; display: flex; justify-content: center; gap: 10px; align-items: center; }
        .fab { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: var(--secondary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1500; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <h1>ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ® üê∫</h1>
        </div>
        <div class="cart-icon" onclick="toggleCart(true)">
            <i class="fas fa-shopping-cart"></i>
            <span id="badge" class="badge-count">0</span>
        </div>
    </header>

    <div id="nav" class="nav-scroll" style="display:none;"></div>

    <div class="container">
        <div id="status" style="text-align:center; padding: 50px;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™...</div>
        <div id="grid" class="grid"></div>
    </div>

    <div class="fab" onclick="toggleCart(true)">
        <i class="fas fa-shopping-basket"></i>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-body">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0;">ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</h3>
                <span onclick="toggleCart(false)" style="font-size:1.5rem; cursor:pointer;">&times;</span>
            </div>
            
            <div id="cartList" class="cart-list">
                <p style="text-align:center; color:#999; margin-top:50px;">ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©</p>
            </div>

            <div id="checkoutArea" class="checkout-box" style="display:none;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px; font-size:1.1rem;">
                    <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                    <span id="totalPrice">0 $</span>
                </div>
                <input type="text" id="cName" class="inp" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿ±ŸäŸÖ">
                <textarea id="cAddr" class="inp" rows="2" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ"></textarea>
                <button class="btn-wa" onclick="sendOrder()">
                    <i class="fa-brands fa-whatsapp"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://sheetdb.io/api/v1/0flk7iaw3nr0g'; 
        const PHONE = '4917623456589';

        let productsRaw = [];
        let cart = JSON.parse(localStorage.getItem('altheeb_cart')) || [];
        let activeCat = 'ÿßŸÑŸÉŸÑ';

        function fixImg(url) {
            if (!url) return 'https://via.placeholder.com/300?text=No+Image';
            if (url.includes('drive.google.com')) {
                const m = url.match(/\/d\/(.+?)\/|id=(.+?)(\&|$)/);
                if (m) return `https://drive.google.com/thumbnail?id=${m[1]||m[2]}&sz=w800`;
            }
            return url;
        }

        // --- ÿØÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ÿ∞ŸÉŸäÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (DD.MM.YYYY) ---
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const str = String(dateStr).trim();
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ŸÜŸÇÿßÿ∑ ŸÖÿ´ŸÑ 09.12.2025
            if (str.includes('.')) {
                const parts = str.split('.');
                // parts[0] = ÿßŸÑŸäŸàŸÖ, parts[1] = ÿßŸÑÿ¥Ÿáÿ±, parts[2] = ÿßŸÑÿ≥ŸÜÿ©
                // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑÿ¥Ÿáÿ± ŸÅŸä ÿ¨ÿßŸÅÿßÿ≥ŸÉÿ±Ÿäÿ®ÿ™ Ÿäÿ®ÿØÿ£ ŸÖŸÜ 0 (ŸäŸÜÿßŸäÿ± = 0)
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            
            // ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑŸÇŸäÿßÿ≥Ÿäÿ©
            return new Date(str);
        }

        function checkDate(start, end) {
            if(!start || !end) return false;
            
            const now = new Date();
            const s = parseDate(start);
            const e = parseDate(end);
            
            // ÿ∂ÿ®ÿ∑ ŸÜŸáÿßŸäÿ© ÿßŸÑŸäŸàŸÖ ŸÑÿ™ÿ¥ŸÖŸÑ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ£ÿÆŸäÿ± ŸÉÿßŸÖŸÑÿßŸã
            if (e) e.setHours(23, 59, 59);
            
            // ÿßŸÑÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ÿµÿßŸÑÿ≠ÿ©
            if (!s || !e || isNaN(s.getTime()) || isNaN(e.getTime())) {
                console.warn(`ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠: ${start} - ${end}`);
                return false;
            }
            
            return now >= s && now <= e;
        }

        async function init() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠
                productsRaw = data.map(item => {
                    const newItem = {};
                    for (let key in item) {
                        newItem[key.trim()] = item[key];
                    }
                    return newItem;
                });
                
                renderCats();
                renderGrid();
                updateBadge();
                document.getElementById('status').style.display = 'none';

            } catch (err) {
                document.getElementById('status').innerHTML = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: ' + err.message;
            }
        }

        function getProductState(item) {
            const isTrue = (val) => {
                const s = String(val).toLowerCase().trim();
                return s === 'true' || s === 'yes' || s === '1' || s === 'ŸÜÿπŸÖ';
            };

            const isActive = isTrue(item['product_active']);
            
            let state = {
                visible: isActive,
                isOffer: false,
                finalPrice: parseFloat(item['price']) || 0,
                oldPrice: null,
                cartName: item['name'],
                badgeText: '',
                badgeColor: '' 
            };

            if (!state.visible) return state;

            const hasOffer = isTrue(item['has_offer']);
            
            if (hasOffer) {
                const offerActive = isTrue(item['offer_aktive']);
                const startStr = item['offer_start_date'];
                const endStr = item['offer_end_date'];
                const validDate = checkDate(startStr, endStr);

                if (offerActive && validDate) {
                    const type = String(item['offer_type']).toLowerCase().trim();

                    // 1. ŸÜÿ≥ÿ®ÿ© ŸÖÿ¶ŸàŸäÿ© (percent)
                    if (type.includes('percent') || type.includes('rabatt') || type.includes('ŸÜÿ≥ÿ®ÿ©')) {
                        // parseFloat Ÿäÿ™ÿπÿßŸÖŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÖÿπ "50%" ŸàŸäÿ≠ŸàŸÑŸáÿß ŸÑŸÄ 50
                        const pct = parseFloat(item['percent']);
                        if (pct > 0) {
                            state.isOffer = true;
                            state.badgeText = `ÿÆÿµŸÖ ${pct}%`;
                            state.badgeColor = 'tag-red';
                            state.oldPrice = state.finalPrice;
                            state.finalPrice = state.finalPrice - (state.finalPrice * pct / 100);
                        }
                    }
                    
                    // 2. ÿ®ÿßŸÉÿØÿ¨ (Bundle)
                    else if (type.includes('bundle') || type.includes('ŸÖÿ¨ŸÖŸàÿπÿ©') || type.includes('ÿπÿØÿØ')) {
                        const qty = parseInt(item['bundle_qty']);
                        const bPrice = parseFloat(item['bundle_price']);

                        if (qty > 1 && bPrice > 0) {
                            state.isOffer = true;
                            state.badgeText = `ÿπÿ±ÿ∂: ${qty} ÿ®ŸÄ ${bPrice}`;
                            state.badgeColor = 'tag-purple';
                            state.oldPrice = (parseFloat(item['price']) || 0) * qty;
                            state.finalPrice = bPrice;
                            state.cartName = `${item['name']} (ÿπÿ±ÿ∂ ${qty} ŸÇÿ∑ÿπ)`;
                        }
                    }
                }
            }
            return state;
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            const filtered = activeCat === 'ÿßŸÑŸÉŸÑ' 
                ? productsRaw 
                : productsRaw.filter(p => p['category'] === activeCat);

            if(filtered.length === 0) {
                grid.innerHTML = '<p style="text-align:center; width:100%;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™.</p>';
                return;
            }

            filtered.forEach(item => {
                const logic = getProductState(item);

                if (!logic.visible) return;

                let priceHtml = '';
                if (logic.isOffer) {
                    let colorClass = logic.badgeColor === 'tag-purple' ? 'purple' : 'red';
                    priceHtml = `
                        <span class="price-cross">${logic.oldPrice.toFixed(2)} $</span>
                        <span class="price-final ${colorClass}">${logic.finalPrice.toFixed(2)} $</span>
                    `;
                    if(logic.badgeColor === 'tag-purple') {
                        priceHtml += `<div class="bundle-note">${logic.badgeText}</div>`;
                    }
                } else {
                    priceHtml = `<span class="price-final">${logic.finalPrice.toFixed(2)} $</span>`;
                }

                const badgeHtml = logic.isOffer ? `<div class="tag ${logic.badgeColor}">${logic.badgeText}</div>` : '';
                const sizeTxt = (item['sizevalue'] && item['sizeunit']) ? `(${item['sizevalue']} ${item['sizeunit']})` : '';

                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    ${badgeHtml}
                    <div class="img-wrap"><img src="${fixImg(item['image'])}" loading="lazy"></div>
                    <div class="info">
                        <div class="title">${item['name']}</div>
                        <div style="font-size:0.85rem; color:#888;">${sizeTxt}</div>
                        <div class="desc">${item['description'] || ''}</div>
                        <div class="pricing">${priceHtml}</div>
                        <button class="btn-add" onclick="addToCart('${item['id']}')">
                            <i class="fa-solid fa-cart-plus"></i> ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©
                        </button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function renderCats() {
            const nav = document.getElementById('nav');
            const cats = ['ÿßŸÑŸÉŸÑ', ...new Set(productsRaw.map(p => p['category']).filter(c=>c))];
            if(cats.length <= 1) return;

            nav.style.display = 'block';
            nav.innerHTML = cats.map(c => 
                `<span class="cat-pill ${c === activeCat ? 'active' : ''}" onclick="setCat('${c}')">${c}</span>`
            ).join('');
        }

        function setCat(c) {
            activeCat = c;
            renderCats();
            renderGrid();
        }

        function addToCart(id) {
            const item = productsRaw.find(p => p['id'] == id);
            if (!item) return;

            const logic = getProductState(item);
            const exist = cart.find(x => x.name === logic.cartName);

            if(exist) {
                exist.qty++;
            } else {
                cart.push({
                    id: item['id'],
                    name: logic.cartName,
                    price: logic.finalPrice,
                    qty: 1
                });
            }
            saveCart();
            updateBadge();
            
            const btn = event.target.closest('button');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> ÿ™ŸÖ';
            btn.style.background = '#27ae60';
            setTimeout(() => {
                btn.innerHTML = oldText;
                btn.style.background = '#2c3e50';
            }, 800);
        }

        function modQty(idx, val) {
            cart[idx].qty += val;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            saveCart();
        }

        function saveCart() {
            localStorage.setItem('altheeb_cart', JSON.stringify(cart));
            renderCart();
        }

        function updateBadge() {
            document.getElementById('badge').innerText = cart.reduce((a,b)=>a+b.qty, 0);
        }

        function toggleCart(show) {
            const el = document.getElementById('modal');
            el.style.display = show ? 'flex' : 'none';
            if(show) renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            const area = document.getElementById('checkoutArea');
            const totalEl = document.getElementById('totalPrice');

            if(cart.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©</p>';
                area.style.display = 'none';
                return;
            }

            area.style.display = 'block';
            let html = '';
            let total = 0;

            cart.forEach((cItem, i) => {
                const lineTotal = cItem.price * cItem.qty;
                total += lineTotal;
                html += `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight:bold;">${cItem.name}</div>
                            <div style="font-size:0.9rem; color:#666;">${cItem.price.toFixed(2)}$ x ${cItem.qty}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button onclick="modQty(${i}, -1)" style="width:25px;height:25px;border-radius:50%;border:none;">-</button>
                            <span>${cItem.qty}</span>
                            <button onclick="modQty(${i}, 1)" style="width:25px;height:25px;border-radius:50%;border:none;">+</button>
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html;
            totalEl.innerText = total.toFixed(2) + ' $';
        }

        function sendOrder() {
            const name = document.getElementById('cName').value;
            const addr = document.getElementById('cAddr').value;
            if(!name) { alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑÿßÿ≥ŸÖ'); return; }

            let msg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ (ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ®)*\nüë§ ÿßŸÑÿßÿ≥ŸÖ: ${name}\nüìç ÿßŸÑÿπŸÜŸàÿßŸÜ: ${addr}\n\n`;
            let total = 0;
            cart.forEach(x => {
                const sub = x.price * x.qty;
                total += sub;
                msg += `‚ñ™ ${x.name} (ÿπÿØÿØ ${x.qty}) = ${sub.toFixed(2)}$\n`;
            });
            msg += `\nüí∞ *ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${total.toFixed(2)} $*`;

            window.open(`https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
            cart = [];
            saveCart();
            toggleCart(false);
            updateBadge();
        }

        init();

    </script>
</body>
</html>
