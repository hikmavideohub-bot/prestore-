<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ® | ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22;
            --green-color: #27ae60;
            --red-color: #c0392b;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
            padding-bottom: 80px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo h1 { margin: 0; font-size: 1.5rem; }
        .logo p { margin: 0; font-size: 0.8rem; opacity: 0.8; }

        .cart-icon-container { position: relative; cursor: pointer; font-size: 1.5rem; }
        .cart-badge {
            position: absolute; top: -8px; right: -10px;
            background-color: var(--accent-color); color: white;
            border-radius: 50%; padding: 4px 8px; font-size: 0.8rem; font-weight: bold;
        }

        .category-nav {
            background: #fff; padding: 10px; overflow-x: auto; white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 70px; z-index: 99;
        }

        .cat-btn {
            display: inline-block; background: #f0f0f0; padding: 8px 16px;
            border-radius: 20px; margin-left: 10px; cursor: pointer; transition: 0.3s;
        }
        .cat-btn.active { background: var(--primary-color); color: white; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        .products-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px;
        }

        .product-card {
            background: var(--card-bg); border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative;
        }

        .product-card.inactive {
            opacity: 0.7;
            filter: grayscale(1);
            border: 2px dashed #999;
            background-color: #f0f0f0;
        }
        .product-card.inactive .add-btn {
            background-color: #999;
            pointer-events: none;
        }

        .discount-badge {
            position: absolute; top: 10px; right: 10px; background-color: var(--red-color);
            color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;
        }
        
        .bundle-badge {
            position: absolute; top: 10px; right: 10px; background-color: var(--green-color);
            color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;
        }
        
        .inactive-badge {
            position: absolute; top: 10px; left: 10px; background-color: #333;
            color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;
            z-index: 2;
        }

        .product-image { width: 100%; height: 150px; object-fit: cover; background-color: #eee; }
        .product-info { padding: 10px; display: flex; flex-direction: column; flex-grow: 1; }
        .product-title { font-size: 1rem; font-weight: bold; margin-bottom: 5px; }
        .product-desc { font-size: 0.8rem; color: #666; margin-bottom: 10px; flex-grow: 1; }

        .price-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .price-old { 
            text-decoration: line-through; 
            color: #999; 
            font-size: 0.85rem; 
            margin-left: 0;
        }
        
        .price-new { 
            font-weight: bold; 
            color: var(--primary-color); 
            font-size: 1.1rem; 
        }
        .price-new.has-discount { color: var(--red-color); }

        .add-btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s;
            margin-top: auto;
        }
        .add-btn:active { transform: scale(0.95); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: flex-end; }
        @media (min-width: 768px) { .modal { align-items: center; } .modal-content { width: 400px; border-radius: 15px; height: auto; max-height: 85vh; } }
        .modal-content { background-color: #fff; width: 100%; height: 90vh; border-radius: 20px 20px 0 0; padding: 20px; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .cart-items-container { flex-grow: 1; overflow-y: auto; margin-bottom: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .item-controls button { background: #eee; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .cart-summary { background: #f9f9f9; padding: 15px; border-radius: 10px; }
        .total-row { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        .checkout-btn { width: 100%; background-color: var(--green-color); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .fab { position: fixed; bottom: 20px; left: 20px; background-color: var(--accent-color); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 90; }

        .admin-toggle {
            text-align: center; margin: 30px 0;
        }
        .admin-toggle button {
            background: #ddd; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; color: #555;
        }
        .section-title {
            margin: 20px 0 10px 0; padding: 0 10px; font-size: 1.2rem; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;
        }
        
        .size-info {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .bundle-info {
            font-size: 0.75rem;
            color: var(--green-color);
            background: #e8f5e9;
            padding: 3px 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <h1>ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ® üê∫</h1>
            <p>ÿ£ÿ¨ŸàÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ∫ÿ∞ÿßÿ¶Ÿäÿ©</p>
        </div>
        <div class="cart-icon-container" onclick="openCart()">
            <i class="fas fa-shopping-cart"></i>
            <span id="cart-badge" class="cart-badge">0</span>
        </div>
    </header>

    <div id="category-nav" class="category-nav" style="display:none;"></div>

    <div class="container">
        <div id="loading" style="text-align:center; padding:50px;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™... ‚è≥</div>
        
        <div id="products-grid" class="products-grid"></div>

        <div class="admin-toggle" id="inactive-toggle" style="display:none;">
            <button onclick="toggleInactive()">ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑŸÜÿ¥ÿ∑ÿ©</button>
        </div>

        <div id="inactive-section" style="display:none;">
            <div class="section-title">‚õî ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑ÿ© / ŸÜŸÅÿ∞ÿ™ ÿßŸÑŸÉŸÖŸäÿ©</div>
            <div id="inactive-grid" class="products-grid"></div>
        </div>
    </div>

    <div class="fab" onclick="openCart()">
        <i class="fas fa-shopping-basket"></i>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ üõí</h3>
                <span onclick="closeCart()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <div id="cart-items" class="cart-items-container">
                <p style="text-align:center; color:#999; margin-top:50px;">ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© ÿ≠ÿßŸÑŸäÿßŸã</p>
            </div>
            <div class="cart-summary" id="cart-summary" style="display:none;">
                <div class="total-row"><span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span><span id="cart-total">0 $</span></div>
                <hr style="margin: 10px 0; border:0; border-top:1px solid #ddd;">
                <input type="text" id="cust-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿ±ŸäŸÖ">
                <textarea id="cust-address" rows="2" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ"></textarea>
                <button class="checkout-btn" onclick="checkout()"><i class="fab fa-whatsapp"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®</button>
            </div>
        </div>
    </div>

    <script>
        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
        const PHONE = '4917623456589'; 
        
        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        let cart = JSON.parse(localStorage.getItem('altheeb_cart')) || [];
        let productsData = [];
        let activeCategory = 'ÿßŸÑŸÉŸÑ';

        // -------------------------
        // ŸÉŸàÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ¨ÿØŸäÿØ ŸàÿßŸÑÿ≥ÿ±Ÿäÿπ (Visualization API)
        // -------------------------
        window.addEventListener('DOMContentLoaded', () => {
            updateCartCount();
            fetchProductsDirectly();
        });

        async function fetchProductsDirectly() {
            const sheetId = '1-0bxz7fqJM3uxblsu1xx24KY5KNkYFu-32EY9893lOA';
            const gid = '0'; // ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ŸàŸÑŸâ
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;

            try {
                const response = await fetch(url);
                const text = await response.text();
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿ±ÿØ ÿ¨Ÿàÿ¨ŸÑ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ JSON ÿµÿßŸÅŸä
                const jsonString = text.substring(47, text.length - 2);
                const json = JSON.parse(jsonString);

                // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿπŸÜÿßŸàŸäŸÜ (ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠) ŸÖŸÜ ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ
                // table.cols Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑÿπŸÜÿßŸàŸäŸÜ (Labels)
                const headers = json.table.cols.map(col => col.label);

                // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿµŸÅŸàŸÅ ÿßŸÑŸÖÿπŸÇÿØÿ© ÿ•ŸÑŸâ ŸÉÿßÿ¶ŸÜÿßÿ™ ÿ®ÿ≥Ÿäÿ∑ÿ©
                const rawProducts = json.table.rows.map(row => {
                    let product = {};
                    row.c.forEach((cell, index) => {
                        // ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ (ŸÖÿ´ŸÑÿßŸã name, price)
                        const key = headers[index];
                        // ÿßŸÑŸÇŸäŸÖÿ© (ŸÜÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸáÿß ŸÑŸäÿ≥ÿ™ null)
                        const value = (cell && cell.v !== null) ? cell.v : "";
                        
                        if(key) {
                            product[key] = value;
                        }
                    });
                    return product;
                });

                console.log('‚úÖ ÿ™ŸÖ ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠:', rawProducts.length);
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ŸàŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                processFetchedData(rawProducts);

            } catch (error) {
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", error);
                document.getElementById('loading').innerHTML = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.';
            }
        }

        // --- Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸàÿßŸÑŸÖŸÜÿ∑ŸÇ (ŸÉŸÖÿß ŸáŸä ŸÅŸä ÿßŸÑÿ≥ÿßÿ®ŸÇ) ---

        function processFetchedData(rawData) {
            // ÿ™ŸÜÿ∏ŸäŸÅ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ÿßŸÑÿ≤ÿßÿ¶ÿØÿ©
            const data = cleanDataKeys(rawData);
            
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑŸäÿ≥ ŸÑŸáÿß ÿßÿ≥ŸÖ
            productsData = data.filter(p => p.name && String(p.name).trim() !== '');
            
            document.getElementById('loading').style.display = 'none';
            renderCategories(productsData);
            renderAllProducts(productsData);
        }

        function convertDriveLink(url) {
            if (!url) return null;
            if (url.includes('drive.google.com')) {
                const idMatch = url.match(/\/d\/(.*?)\/|id=(.*?)(&|$)/);
                if (idMatch) {
                    const id = idMatch[1] || idMatch[2];
                    return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
                }
            }
            return url;
        }

        function parseGermanDate(dateString) {
            if (!dateString) return null;
            
            const str = dateString.toString().trim();
            
            // ÿµŸäÿ∫ÿ© DD.MM.YYYY
            if (str.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
                const parts = str.split('.');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return new Date(`${year}-${month}-${day}`);
            }
            
            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿπÿßÿØŸä
            try {
                // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: Visualization API ÿ£ÿ≠ŸäÿßŸÜÿßŸã ÿ™ÿ±ÿ≥ŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ®ÿµŸäÿ∫ÿ© "Date(2023, 11, 25)"
                if (typeof str === 'string' && str.includes('Date')) {
                   const nums = str.match(/\d+/g);
                   if(nums && nums.length >= 3) {
                       return new Date(nums[0], nums[1], nums[2]);
                   }
                }
                return new Date(str);
            } catch (e) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:', str, e);
                return null;
            }
        }

        function cleanPercent(percentValue) {
            if (!percentValue) return 0;
            
            const str = percentValue.toString().trim();
            const cleanStr = str.replace('%', '').replace('Ÿ™', '');
            
            const num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : num;
        }

        function cleanDataKeys(data) {
            return data.map(item => {
                const newItem = {};
                Object.keys(item).forEach(key => {
                    const cleanKey = key.trim();
                    newItem[cleanKey] = item[key];
                });
                return newItem;
            });
        }

        function checkBooleanValue(value) {
            if (!value) return false;
            
            // ŸÅŸä ÿ≠ÿßŸÑÿ© Visualization API ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ®ŸàŸÑŸäÿßŸÜ ŸÇÿØ ÿ™ÿ£ÿ™Ÿä ŸÉŸÄ true/false ŸÖÿ®ÿßÿ¥ÿ±ÿ©
            if (typeof value === 'boolean') return value;

            const strValue = value.toString().toLowerCase().trim();
            return (
                strValue === 'true' || 
                strValue === 'yes' || 
                strValue === '1' || 
                strValue === 'ŸÜÿπŸÖ' ||
                strValue === '‚úì' ||
                strValue === '‚úî' ||
                strValue === 'ÿµÿ≠Ÿäÿ≠' ||
                strValue === 'ÿµÿ≠'
            );
        }

        function isProductActive(product) {
            return checkBooleanValue(product.product_active);
        }

        function hasOffer(product) {
            return checkBooleanValue(product.has_offer);
        }

        function isOfferActive(product) {
            if (!checkBooleanValue(product.offer_aktive)) {
                return false;
            }
            
            const now = new Date();
            const startDate = product.offer_start_date ? parseGermanDate(product.offer_start_date) : null;
            const endDate = product.offer_end_date ? parseGermanDate(product.offer_end_date) : null;
            
            if (startDate && endDate) {
                try {
                    const endOfDay = new Date(endDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    
                    if (now < startDate || now > endOfDay) {
                        return false;
                    }
                } catch (e) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ:', e);
                    return false;
                }
            }
            
            return true;
        }

        function calculatePrice(product) {
            const originalPrice = parseFloat(product.price) || 0;
            let finalPrice = originalPrice;
            let hasDiscount = false;
            let hasBundle = false;
            let discountPercent = 0;
            let bundleInfo = null;

            if (hasOffer(product) && isOfferActive(product)) {
                const offerType = (product.offer_type || '').toLowerCase();
                
                if (offerType.includes('percent') || offerType.includes('rabatt') || offerType.includes('discount')) {
                    discountPercent = cleanPercent(product.percent);
                    if (discountPercent > 0 && discountPercent <= 100) {
                        finalPrice = originalPrice - (originalPrice * discountPercent / 100);
                        hasDiscount = true;
                    }
                } 
                else if (offerType.includes('bundle')) {
                    const bundleQty = parseInt(product.bundle_qty) || 1;
                    const bundlePrice = parseFloat(product.bundle_price) || originalPrice;
                    
                    if (bundleQty > 1 && bundlePrice > 0) {
                        hasBundle = true;
                        bundleInfo = {
                            qty: bundleQty,
                            price: bundlePrice,
                            unitPrice: bundlePrice / bundleQty
                        };
                    }
                }
            }

            return {
                originalPrice: originalPrice,
                finalPrice: parseFloat(finalPrice.toFixed(2)),
                hasDiscount: hasDiscount,
                hasBundle: hasBundle,
                bundleInfo: bundleInfo,
                discountPercent: discountPercent
            };
        }

        function calculateCartItemPrice(item) {
            let total = 0;
            
            if (item.hasBundle && item.bundleInfo) {
                const bundles = Math.floor(item.qty / item.bundleInfo.qty);
                const remainder = item.qty % item.bundleInfo.qty;
                total = (bundles * item.bundleInfo.price) + (remainder * item.originalPrice);
            } else if (item.hasDiscount) {
                total = item.finalPrice * item.qty;
            } else {
                total = item.originalPrice * item.qty;
            }
            
            return parseFloat(total.toFixed(2));
        }

        function renderAllProducts(products) {
            let filtered = products;
            if (activeCategory !== 'ÿßŸÑŸÉŸÑ') {
                filtered = products.filter(p => p.category && p.category.trim() === activeCategory);
            }

            const activeProducts = [];
            const inactiveProducts = [];

            filtered.forEach(p => {
                if (isProductActive(p)) {
                    activeProducts.push(p);
                } else {
                    inactiveProducts.push(p);
                }
            });

            renderGrid('products-grid', activeProducts, false);

            const inactiveContainer = document.getElementById('inactive-section');
            const toggleBtn = document.getElementById('inactive-toggle');
            
            if (inactiveProducts.length > 0) {
                toggleBtn.style.display = 'block';
                renderGrid('inactive-grid', inactiveProducts, true);
            } else {
                toggleBtn.style.display = 'none';
                inactiveContainer.style.display = 'none';
            }
        }

        function renderGrid(containerId, products, isInactive) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';

            if (products.length === 0 && !isInactive) {
                grid.innerHTML = '<p style="text-align:center; width:100%; grid-column:1/-1;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÜÿ¥ÿ∑ÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ</p>';
                return;
            }

            products.forEach(p => {
                const pricing = calculatePrice(p);
                const imgSrc = convertDriveLink(p.image) || 'https://via.placeholder.com/150';
                
                let priceHTML = '';
                let badgeHTML = '';
                
                if (pricing.hasDiscount) {
                    priceHTML = `
                        <div class="price-container">
                            <span class="price-old" dir="ltr">${pricing.originalPrice.toFixed(2)} $</span>
                            <span class="price-new has-discount" dir="ltr">${pricing.finalPrice.toFixed(2)} $</span>
                        </div>`;
                    badgeHTML = `<div class="discount-badge">ÿÆÿµŸÖ ${pricing.discountPercent}%</div>`;
                } else if (pricing.hasBundle) {
                    priceHTML = `
                        <div class="price-container">
                            <span class="price-old" dir="ltr">${pricing.originalPrice.toFixed(2)} $</span>
                            <span class="price-new has-discount" dir="ltr">${pricing.bundleInfo.unitPrice.toFixed(2)} $</span>
                        </div>`;
                    badgeHTML = `<div class="bundle-badge">ÿπÿ±ÿ∂ ÿ≠ÿ≤ŸÖÿ©</div>`;
                } else {
                    priceHTML = `
                        <div class="price-container">
                            <span class="price-new" dir="ltr">${pricing.originalPrice.toFixed(2)} $</span>
                        </div>`;
                }
                
                let cardClass = isInactive ? 'product-card inactive' : 'product-card';
                let inactiveBadge = isInactive ? '<div class="inactive-badge">ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±</div>' : '';
                let btnState = isInactive ? 'disabled' : '';
                let btnText = isInactive ? 'ŸÜŸÅÿ∞ÿ™ ÿßŸÑŸÉŸÖŸäÿ©' : '<i class="fas fa-plus"></i> ÿ£ÿ∂ŸÅ';
                let btnClick = isInactive ? '' : `onclick="addToCart('${p.id || p.name}')"`;
                
                const sizeValue = p.sizevalue || '';
                const sizeUnit = p.sizeunit || '';
                const sizeDisplay = sizeValue && sizeUnit ? 
                    `<div class="size-info"><strong>ÿßŸÑÿ≠ÿ¨ŸÖ:</strong> ${sizeValue} ${sizeUnit}</div>` : '';
                
                const bundleDisplay = pricing.hasBundle ? 
                    `<div class="bundle-info">${pricing.bundleInfo.qty} ŸÇÿ∑ÿπ ÿ®ŸÄ ${pricing.bundleInfo.price.toFixed(2)}$</div>` : '';

                grid.innerHTML += `
                    <div class="${cardClass}">
                        ${badgeHTML}
                        ${inactiveBadge}
                        <img src="${imgSrc}" class="product-image" loading="lazy" alt="${p.name}" referrerpolicy="no-referrer">
                        <div class="product-info">
                            <div class="product-title">${p.name}</div>
                            ${sizeDisplay}
                            <div class="product-desc">${p.description || ''}</div>
                            ${bundleDisplay}
                            <div class="product-footer">
                                ${priceHTML}
                                <button class="add-btn" ${btnClick} ${btnState}>
                                    ${btnText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function toggleInactive() {
            const section = document.getElementById('inactive-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }

        function renderCategories(products) {
            const nav = document.getElementById('category-nav');
            const rawCategories = products.map(p => p.category);
            const uniqueCategories = [...new Set(rawCategories.filter(c => c && c.trim() !== ''))];

            if (uniqueCategories.length > 0) {
                nav.style.display = 'block';
                nav.innerHTML = '';
                const allBtn = document.createElement('span');
                allBtn.className = 'cat-btn active';
                allBtn.innerText = 'ÿßŸÑŸÉŸÑ';
                allBtn.onclick = () => filterProducts('ÿßŸÑŸÉŸÑ', allBtn);
                nav.appendChild(allBtn);
                uniqueCategories.forEach(cat => {
                    const btn = document.createElement('span');
                    btn.className = 'cat-btn';
                    btn.innerText = cat;
                    btn.onclick = () => filterProducts(cat, btn);
                    nav.appendChild(btn);
                });
            }
        }

        function filterProducts(category, btnElement) {
            activeCategory = category;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            renderAllProducts(productsData);
        }

        function addToCart(identifier) {
            const product = productsData.find(p => (p.id || p.name) == identifier);
            if (!product) return;
            
            const pricing = calculatePrice(product);
            const existingItem = cart.find(item => item.id === (product.id || product.name));
            
            if (existingItem) {
                existingItem.qty++;
            } else {
                const cartItem = {
                    id: product.id || product.name,
                    name: product.name,
                    originalPrice: pricing.originalPrice,
                    finalPrice: pricing.finalPrice,
                    hasDiscount: pricing.hasDiscount,
                    hasBundle: pricing.hasBundle,
                    bundleInfo: pricing.bundleInfo,
                    qty: 1,
                    sizeValue: product.sizevalue,
                    sizeUnit: product.sizeunit
                };
                cart.push(cartItem);
            }
            
            saveCart();
            updateCartCount();
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.style.background = '#27ae60';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '#2c3e50';
            }, 1000);
        }

        function saveCart() {
            localStorage.setItem('altheeb_cart', JSON.stringify(cart));
            renderCartItems();
        }

        function updateCartCount() {
            const count = cart.reduce((acc, item) => acc + item.qty, 0);
            document.getElementById('cart-badge').innerText = count;
        }

        function changeQty(id, change) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.qty += change;
                if (item.qty <= 0) {
                    cart = cart.filter(i => i.id !== id);
                }
                saveCart();
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            const summary = document.getElementById('cart-summary');
            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© üõí</p>';
                summary.style.display = 'none';
                return;
            }
            
            summary.style.display = 'block';
            let html = '';
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = calculateCartItemPrice(item);
                total += itemTotal;
                
                let priceDisplay = '';
                if (item.hasBundle) {
                    priceDisplay = `
                        <span style="font-size:0.8rem;">
                            ÿ≥ÿπÿ± ÿßŸÑŸÇÿ∑ÿπÿ©: ${item.originalPrice.toFixed(2)}$ 
                            | ÿßŸÑÿ®ÿßŸÇÿ©: ${item.bundleInfo.qty} ÿ®ŸÄ ${item.bundleInfo.price.toFixed(2)}$
                        </span>`;
                } else if (item.hasDiscount) {
                    priceDisplay = `
                        <span style="text-decoration:line-through; color:#999; font-size:0.8rem;">
                            ${item.originalPrice.toFixed(2)}$
                        </span>
                        <span style="color:#c0392b; font-weight:bold;">
                            ${item.finalPrice.toFixed(2)}$
                        </span>`;
                } else {
                    priceDisplay = `<span>${item.originalPrice.toFixed(2)}$</span>`;
                }
                
                const sizeInfo = item.sizeValue && item.sizeUnit ? 
                    `<div style="font-size:0.75rem; color:#666;">${item.sizeValue} ${item.sizeUnit}</div>` : '';
                
                html += `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight:bold;">${item.name}</div>
                            ${sizeInfo}
                            <div style="font-size:0.85rem; margin-top:4px;">
                                ${priceDisplay} √ó ${item.qty}
                                <div style="color:var(--primary-color); font-weight:bold;">
                                    ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${itemTotal.toFixed(2)}$
                                </div>
                            </div>
                        </div>
                        <div class="item-controls" style="display:flex; align-items:center; gap:10px;">
                            <button onclick="changeQty('${item.id}', -1)">-</button>
                            <span>${item.qty}</span>
                            <button onclick="changeQty('${item.id}', 1)">+</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = html;
            document.getElementById('cart-total').innerText = total.toFixed(2) + ' $';
        }

        function openCart() {
            renderCartItems();
            document.getElementById('cartModal').style.display = 'flex';
        }

        function closeCart() {
            document.getElementById('cartModal').style.display = 'none';
        }

        function checkout() {
            const name = document.getElementById('cust-name').value;
            const address = document.getElementById('cust-address').value;
            
            if (!name || cart.length === 0) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™');
                return;
            }
            
            let msg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ ŸÖŸÜ ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ® üê∫*\n`;
            msg += `========================\n`;
            msg += `üë§ ÿßŸÑÿßÿ≥ŸÖ: ${name}\n`;
            msg += `üìç ÿßŸÑÿπŸÜŸàÿßŸÜ: ${address}\n`;
            msg += `========================\n`;
            msg += `üìã *ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™:*\n\n`;
            
            let total = 0;
            let savedAmount = 0;
            
            cart.forEach(item => {
                const itemTotal = calculateCartItemPrice(item);
                total += itemTotal;
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÅÿ±
                const originalTotal = item.originalPrice * item.qty;
                savedAmount += (originalTotal - itemTotal);
                
                msg += `‚ñ™Ô∏è ${item.name}\n`;
                if (item.sizeValue && item.sizeUnit) {
                    msg += `   ÿßŸÑÿ≠ÿ¨ŸÖ: ${item.sizeValue} ${item.sizeUnit}\n`;
                }
                msg += `   ÿßŸÑŸÉŸÖŸäÿ©: ${item.qty}\n`;
                
                if (item.hasBundle) {
                    msg += `   ÿßŸÑÿ≥ÿπÿ±: ${item.originalPrice.toFixed(2)}$ (ÿßŸÑÿ®ÿßŸÇÿ©: ${item.bundleInfo.qty} ÿ®ŸÄ ${item.bundleInfo.price.toFixed(2)}$)\n`;
                } else if (item.hasDiscount) {
                    msg += `   ÿßŸÑÿ≥ÿπÿ±: ${item.finalPrice.toFixed(2)}$ (ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ${item.originalPrice.toFixed(2)}$)\n`;
                } else {
                    msg += `   ÿßŸÑÿ≥ÿπÿ±: ${item.originalPrice.toFixed(2)}$\n`;
                }
                
                msg += `   ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${itemTotal.toFixed(2)}$\n\n`;
            });
            
            msg += `========================\n`;
            if (savedAmount > 0) {
                msg += `üéâ *ŸÑŸÇÿØ ŸàŸÅÿ±ÿ™: ${savedAmount.toFixed(2)}$*\n`;
            }
            msg += `üí∞ *ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ${total.toFixed(2)}$*`;
            
            window.open(`https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
            localStorage.removeItem('altheeb_cart');
            cart = [];
            updateCartCount();
            closeCart();
        }
    </script>
</body>
</html>
