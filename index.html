<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ®</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: #f5f5f5; padding-top: 80px; }
        
        /* Header */
        header { background: #2c3e50; color: white; padding: 1rem 2rem; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo h1 { font-size: 1.5rem; }
        .cart-icon { position: relative; cursor: pointer; font-size: 1.5rem; }
        .cart-badge { position: absolute; top: -8px; left: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }
        
        /* Main */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .loading { text-align: center; padding: 3rem; color: #7f8c8d; }
        .loading-spinner { display: inline-block; width: 50px; height: 50px; border: 4px solid #ecf0f1; border-top-color: #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Products Grid */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .product-image { width: 100%; height: 200px; object-fit: cover; }
        .product-info { padding: 1.25rem; }
        .product-title { font-size: 1.125rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.5rem; }
        .product-desc { color: #7f8c8d; font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.5; }
        .product-price { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .price-old { text-decoration: line-through; color: #95a5a6; font-size: 0.9rem; }
        .price-new { font-size: 1.5rem; font-weight: 700; color: #2c3e50; }
        .price-new.discount { color: #e74c3c; }
        .discount-badge { position: absolute; top: 0.75rem; right: 0.75rem; background: #e74c3c; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .add-btn { width: 100%; background: #3498db; color: white; border: none; padding: 0.875rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .add-btn:hover { background: #2980b9; }
        
        /* Cart Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; max-height: 90vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { padding: 1.25rem; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center; }
        .close-modal { background: none; border: none; font-size: 1.75rem; color: #7f8c8d; cursor: pointer; }
        .cart-items { flex: 1; overflow-y: auto; padding: 1.25rem; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #ecf0f1; }
        .item-controls { display: flex; align-items: center; gap: 0.75rem; }
        .item-controls button { width: 32px; height: 32px; border: none; background: #ecf0f1; color: #2c3e50; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .cart-summary { padding: 1.25rem; border-top: 2px solid #ecf0f1; }
        .total-row { display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
        .checkout-btn { width: 100%; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 1rem; border-radius: 10px; font-size: 1.125rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        input, textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 0.75rem; font-family: 'Tajawal', sans-serif; }
        
        @media (max-width: 768px) {
            .products-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
            .product-card { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <h1 id="store-name">Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</h1>
            </div>
            <div class="cart-icon" onclick="openCart()">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-badge" id="cart-badge">0</span>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™...</p>
            </div>
            <div id="products-grid" class="products-grid"></div>
        </div>
    </main>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</h3>
                <button class="close-modal" onclick="closeCart()">&times;</button>
            </div>
            <div id="cart-items" class="cart-items"></div>
            <div class="cart-summary" id="cart-summary" style="display:none;">
                <div class="total-row">
                    <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                    <span id="cart-total">0 ‚Ç¨</span>
                </div>
                <input type="text" id="cust-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ *" required>
                <textarea id="cust-address" rows="2" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ *" required></textarea>
                <button class="checkout-btn" onclick="checkout()">
                    <i class="fab fa-whatsapp"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
                </button>
            </div>
        </div>
    </div>

    <script>
        /* ========================================
           ‚öôÔ∏è ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ™ÿ≠ŸÉŸÖ
           ======================================== */
        const STORE_ID = 'a083e1e2'; // ‚¨ÖÔ∏è ÿ∂ÿπ storeId ŸáŸÜÿß
        const API_URL = 'https://script.google.com/macros/s/AKfycbxmTLI6-1V7tELp7uvkDnCAMDCp6M5ZPsl4lZFL6KmaBRH9Hc9dqQdsgRDs0deca4RV6w/exec';
        
        let CURRENCY = '‚Ç¨';
        let PHONE = '';
        let STORE_NAME = 'ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ®';
        let cart = JSON.parse(localStorage.getItem('cart_' + STORE_ID)) || [];
        let productsData = [];
        
        /* ========================================
           üöÄ ÿßŸÑÿ™ŸáŸäÿ¶ÿ©
           ======================================== */
        window.addEventListener('DOMContentLoaded', async () => {
            updateCartCount();
            await loadStoreConfig();
            await fetchProducts();
        });
        
        /* ========================================
           üì° ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
           ======================================== */
        async function loadStoreConfig() {
            try {
                const res = await fetch(`${API_URL}?type=storeConfig&storeId=${STORE_ID}`);
                const json = await res.json();
                if (!json.success) throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                
                const data = json.data;
                CURRENCY = data.currency || '‚Ç¨';
                PHONE = data.whatsapp || data.phone || '';
                STORE_NAME = data.store_name || 'ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ∞Ÿäÿ®';
                
                document.getElementById('store-name').textContent = STORE_NAME;
                document.title = STORE_NAME;
            } catch (e) {
                console.error('ÿÆÿ∑ÿ£:', e);
            }
        }
        
        /* ========================================
           üì° ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
           ======================================== */
        async function fetchProducts() {
            try {
                const res = await fetch(`${API_URL}?type=products&storeId=${STORE_ID}&_ts=${Date.now()}`);
                const json = await res.json();
                if (!json.success) throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ');
                
                productsData = (json.products || []).filter(p => 
                    p.name && 
                    String(p.name).trim() !== '' &&
                    (p.productActive === true || p.product_active === true)
                );
                
                document.getElementById('loading').style.display = 'none';
                renderProducts(productsData);
            } catch (e) {
                document.getElementById('loading').innerHTML = '<p style="color:red;">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</p>';
            }
        }
        
        /* ========================================
           üñºÔ∏è ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
           ======================================== */
        function renderProducts(products) {
            const grid = document.getElementById('products-grid');
            if (products.length === 0) {
                grid.innerHTML = '<p style="text-align:center;color:#7f8c8d;grid-column:1/-1;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™</p>';
                return;
            }
            
            grid.innerHTML = products.map(p => {
                const price = parseFloat(p.price) || 0;
                const hasOffer = p.has_offer === true || p.hasOffer === true;
                const percent = parseFloat(p.percent || 0);
                const finalPrice = hasOffer && percent > 0 ? price - (price * percent / 100) : price;
                
                const priceHTML = hasOffer && percent > 0 ? `
                    <span class="price-old">${price.toFixed(2)} ${CURRENCY}</span>
                    <span class="price-new discount">${finalPrice.toFixed(2)} ${CURRENCY}</span>
                ` : `<span class="price-new">${price.toFixed(2)} ${CURRENCY}</span>`;
                
                const badge = hasOffer && percent > 0 ? `<div class="discount-badge">ÿÆÿµŸÖ ${percent}%</div>` : '';
                
                return `
                    <div class="product-card">
                        <div style="position:relative;">
                            <img src="${p.image || 'https://via.placeholder.com/300x200?text=ÿµŸàÿ±ÿ©'}" class="product-image" alt="${p.name}">
                            ${badge}
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">${p.name}</h3>
                            <p class="product-desc">${p.description || ''}</p>
                            <div class="product-price">${priceHTML}</div>
                            <button class="add-btn" onclick="addToCart('${p.id}')">
                                <i class="fas fa-plus"></i> ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        /* ========================================
           üõí ÿßŸÑÿ≥ŸÑÿ©
           ======================================== */
        function addToCart(id) {
            const product = productsData.find(p => p.id == id);
            if (!product) return;
            
            const price = parseFloat(product.price) || 0;
            const hasOffer = product.has_offer === true;
            const percent = parseFloat(product.percent || 0);
            const finalPrice = hasOffer && percent > 0 ? price - (price * percent / 100) : price;
            
            const existing = cart.find(i => i.id === id);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: finalPrice,
                    qty: 1
                });
            }
            
            saveCart();
        }
        
        function saveCart() {
            localStorage.setItem('cart_' + STORE_ID, JSON.stringify(cart));
            updateCartCount();
            renderCart();
        }
        
        function updateCartCount() {
            document.getElementById('cart-badge').textContent = cart.reduce((sum, i) => sum + i.qty, 0);
        }
        
        function changeQty(id, delta) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
                saveCart();
            }
        }
        
        function renderCart() {
            const container = document.getElementById('cart-items');
            const summary = document.getElementById('cart-summary');
            
            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:2rem;">ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©</p>';
                summary.style.display = 'none';
                return;
            }
            
            summary.style.display = 'block';
            let total = 0;
            
            container.innerHTML = cart.map(item => {
                total += item.price * item.qty;
                return `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight:600;margin-bottom:0.25rem;">${item.name}</div>
                            <div style="color:#7f8c8d;font-size:0.875rem;">${item.price.toFixed(2)} ${CURRENCY}</div>
                        </div>
                        <div class="item-controls">
                            <button onclick="changeQty('${item.id}', -1)">-</button>
                            <span style="font-weight:600;min-width:30px;text-align:center;">${item.qty}</span>
                            <button onclick="changeQty('${item.id}', 1)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('cart-total').textContent = total.toFixed(2) + ' ' + CURRENCY;
        }
        
        function openCart() {
            renderCart();
            document.getElementById('cartModal').classList.add('active');
        }
        
        function closeCart() {
            document.getElementById('cartModal').classList.remove('active');
        }
        
        function checkout() {
            const name = document.getElementById('cust-name').value.trim();
            const address = document.getElementById('cust-address').value.trim();
            
            if (!name || cart.length === 0) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™');
                return;
            }
            
            let msg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ ŸÖŸÜ ${STORE_NAME}*\n\n`;
            msg += `üë§ ÿßŸÑÿßÿ≥ŸÖ: ${name}\n`;
            msg += `üìç ÿßŸÑÿπŸÜŸàÿßŸÜ: ${address}\n`;
            msg += `üìÖ ${new Date().toLocaleDateString('ar')}\n\n`;
            msg += `üìã *ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™:*\n\n`;
            
            let total = 0;
            cart.forEach(item => {
                const itemTotal = item.price * item.qty;
                total += itemTotal;
                msg += `‚ñ™Ô∏è ${item.name}\n`;
                msg += `   ÿßŸÑŸÉŸÖŸäÿ©: ${item.qty}\n`;
                msg += `   ÿßŸÑÿ≥ÿπÿ±: ${item.price.toFixed(2)}${CURRENCY}\n`;
                msg += `   ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${itemTotal.toFixed(2)}${CURRENCY}\n\n`;
            });
            
            msg += `üí∞ *ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${total.toFixed(2)}${CURRENCY}*\n`;
            
            window.open(`https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
            
            cart = [];
            saveCart();
            closeCart();
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-address').value = '';
        }
        
        document.getElementById('cartModal').addEventListener('click', (e) => {
            if (e.target.id === 'cartModal') closeCart();
        });
    </script>
</body>
</html>
